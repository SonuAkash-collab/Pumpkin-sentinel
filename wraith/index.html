<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wraith Wheels ‚Äî The Night Watcher</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css?v=12" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
</head>
<body>
  <!-- Animated background elements -->
  <div class="bg-animation">
    <div class="floating-ghost ghost-1">üëª</div>
    <div class="floating-ghost ghost-2">ü¶á</div>
    <div class="floating-ghost ghost-3">üëª</div>
    <div class="fog"></div>
  </div>

  <header>
    <div class="moon">üåï</div>
    <h1 class="spooky-title">
      <span class="icon-float">üéÉ</span>
      WRAITH WHEELS
      <span class="icon-float">ü¶á</span>
    </h1>
    <p class="subtitle glitch" data-text="The Night Watcher">The Night Watcher</p>
    <p class="tagline">Stay awake... or face the pumpkin's curse üíÄ</p>
  </header>

  <main>
    <div class="container">
      <!-- Sidebar Controls -->
      <aside class="sidebar">
        <div class="control-section">
          <div class="action-buttons">
            <button id="startBtn" class="btn-primary">
              <span class="btn-icon">üïØÔ∏è</span>
              AWAKEN
            </button>
            <button id="stopBtn" class="btn-secondary" disabled>
              <span class="btn-icon">‚ö∞Ô∏è</span>
              REST
            </button>
          </div>
        </div>

        <!-- Basic Settings -->
        <details class="accordion" open>
          <summary class="accordion-header">
            <span class="accordion-icon">üëÅÔ∏è</span>
            <span>Basic Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="threshold">Eye Threshold <span id="thresholdVal" class="value-badge">0.24</span></label>
              <input type="range" id="threshold" min="0.12" max="0.35" step="0.01" value="0.24" />
            </div>
            <div class="control">
              <label for="duration">Closed Duration (sec) <span id="durationVal" class="value-badge">1.5</span></label>
              <input type="range" id="duration" min="0.5" max="3.0" step="0.1" value="1.5" />
            </div>
            <div class="control">
              <label for="hideDelay">Pumpkin Hide Delay (sec) <span id="hideDelayVal" class="value-badge">0.40</span></label>
              <input type="range" id="hideDelay" min="0.0" max="2.0" step="0.05" value="0.40" />
            </div>
            <div class="control">
              <label for="pumpkinDelay">Pumpkin Show Delay (sec) <span id="pumpkinDelayVal" class="value-badge">1.00</span></label>
              <input type="range" id="pumpkinDelay" min="0.0" max="5.0" step="0.1" value="1.0" />
            </div>
          </div>
        </details>

        <!-- CNN Settings -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üß†</span>
            <span>AI Vision (CNN)</span>
          </summary>
          <div class="accordion-content">
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="useCnn" />
                <span class="slider"></span>
              </label>
              <span>Enable CNN Eye Classifier</span>
            </div>
            <div class="control">
              <label for="cnnThresh">CNN Closed Prob <span id="cnnThreshVal" class="value-badge">0.60</span></label>
              <input type="range" id="cnnThresh" min="0.30" max="0.90" step="0.01" value="0.60" />
            </div>
            <div class="control">
              <label for="cnnPumpkinDelay">CNN Pumpkin Delay (sec) <span id="cnnPumpkinDelayVal" class="value-badge">2.0</span></label>
              <input type="range" id="cnnPumpkinDelay" min="0.0" max="5.0" step="0.1" value="2.0" />
            </div>
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="useMouthCnn" />
                <span class="slider"></span>
              </label>
              <span>Enable Mouth Classifier</span>
            </div>
              <div class="control">
                <button id="diagBtn" class="btn-secondary">Run CNN Diagnostic</button>
                <div id="diagOutput" class="diag-output">&#8203;</div>
              </div>
          </div>
        </details>

        <!-- Head Tilt Settings -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üîÑ</span>
            <span>Head Tilt Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="tiltThresh">Tilt Threshold (deg) <span id="tiltThreshVal" class="value-badge">12</span></label>
              <input type="range" id="tiltThresh" min="5" max="30" step="1" value="12" />
            </div>
            <div class="control">
              <label for="tiltCooldown">Tilt Cooldown (sec) <span id="tiltCooldownVal" class="value-badge">2.5</span></label>
              <input type="range" id="tiltCooldown" min="0.5" max="5.0" step="0.1" value="2.5" />
            </div>
          </div>
        </details>

        <!-- Yawn Detection -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">ü•±</span>
            <span>Yawn Detection</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="yawnThresh">Yawn Probability <span id="yawnThreshVal" class="value-badge">0.60</span></label>
              <input type="range" id="yawnThresh" min="0.25" max="0.95" step="0.01" value="0.60" />
            </div>
            <div class="control">
              <label for="yawnCooldown">Yawn Cooldown (sec) <span id="yawnCooldownVal" class="value-badge">3.0</span></label>
              <input type="range" id="yawnCooldown" min="1.0" max="10.0" step="0.5" value="3.0" />
            </div>
            <div class="control">
              <label for="yawnMorMin">Min Mouth Opening <span id="yawnMorMinVal" class="value-badge">0.35</span></label>
              <input type="range" id="yawnMorMin" min="0.20" max="0.70" step="0.01" value="0.35" />
            </div>
            <div class="control">
              <label for="yawnMinDur">Min Duration (sec) <span id="yawnMinDurVal" class="value-badge">0.5</span></label>
              <input type="range" id="yawnMinDur" min="0.1" max="2.0" step="0.1" value="0.5" />
            </div>
          </div>
        </details>

        <!-- Sleep Predictor -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üõå</span>
            <span>Sleep Predictor</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <label for="sleepPersona">Persona</label>
              <select id="sleepPersona">
                <option value="early">Early bird</option>
                <option value="normal" selected>Normal</option>
                <option value="owl">Night owl</option>
              </select>
            </div>
            <div class="control">
              <label for="sleepSpeed">Mode</label>
              <select id="sleepSpeed">
                <option value="demo" selected>Demo (1 sec = 1 min)</option>
                <option value="real">Real time</option>
              </select>
            </div>
            <div class="control">
              <label for="sleepPreset">Preset</label>
              <select id="sleepPreset">
                <option value="tuned" selected>Tuned (current)</option>
                <option value="classic">Classic (previous)</option>
              </select>
            </div>
            <div class="action-buttons">
              <button id="sleepStartBtn" class="btn-primary">Start</button>
              <button id="sleepStopBtn" class="btn-secondary" disabled>Stop</button>
            </div>
            <div class="control">
              <label for="sleepJumpTime">Jump to time (Demo)</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input type="time" id="sleepJumpTime" value="05:00" />
                <button id="sleepJumpBtn" class="btn-secondary">Set</button>
              </div>
              <p class="hint">Works in Demo mode. Quickly test pre-dawn risk around ~05:00.</p>
            </div>
            <div class="control">
              <label>Risk</label>
              <div class="bar" style="height:10px;background:#222;border-radius:6px;overflow:hidden">
                <div id="sleepRiskBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#ff9800,#f44336)"></div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:6px">
                <span id="sleepRisk" class="value-badge">0%</span>
                <span>ETA to bed: <strong id="sleepEta">--:--</strong></span>
              </div>
            </div>
            <div class="control">
              <label>Factors</label>
              <div id="sleepFactors" style="display:flex;flex-wrap:wrap;gap:6px"></div>
            </div>
          </div>
        </details>

        <!-- Debug Mode -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üï∑Ô∏è</span>
            <span>Debug / Capture</span>
          </summary>
          <div class="accordion-content">
            <div class="control checkbox-control">
              <label class="switch">
                <input type="checkbox" id="captureMode" />
                <span class="slider"></span>
              </label>
              <span>Dataset Capture Mode</span>
            </div>
            <p class="hint">Press n/o/s/y keys to save crops</p>
          </div>
        </details>

        

        <!-- Alerts (simulated) -->
        <details class="accordion">
          <summary class="accordion-header">
            <span class="accordion-icon">üìç</span>
            <span>Alerts</span>
          </summary>
          <div class="accordion-content">
            <div class="control">
              <button id="alertTestBtn" class="btn-secondary">Send Test Location Ping</button>
            </div>
            <div id="alertStatus" class="hint" style="min-height:1.2em"></div>
          </div>
        </details>
      </aside>

      <!-- Main Content -->
      <section class="main-content">
        <!-- Video Stage -->
        <div class="video-stage">
          <div class="gothic-frame">
            <div class="frame-corner corner-tl">
              <svg width="80" height="80" viewBox="0 0 80 80"><path d="M0,20 Q0,0 20,0 L0,0 Z M0,40 L0,80 L10,80 L10,45 Z M20,0 L60,0 L60,10 L25,10 Z" fill="currentColor"/></svg>
            </div>
            <div class="frame-corner corner-tr">
              <svg width="80" height="80" viewBox="0 0 80 80"><path d="M60,0 Q80,0 80,20 L80,0 Z M40,0 L0,0 L0,10 L35,10 Z M80,40 L80,80 L70,80 L70,45 Z" fill="currentColor"/></svg>
            </div>
            <div class="frame-corner corner-bl">
              <svg width="80" height="80" viewBox="0 0 80 80"><path d="M0,60 Q0,80 20,80 L0,80 Z M0,40 L0,0 L10,0 L10,35 Z M20,80 L60,80 L60,70 L25,70 Z" fill="currentColor"/></svg>
            </div>
            <div class="frame-corner corner-br">
              <svg width="80" height="80" viewBox="0 0 80 80"><path d="M60,80 Q80,80 80,60 L80,80 Z M40,80 L0,80 L0,70 L35,70 Z M80,40 L80,0 L70,0 L70,35 Z" fill="currentColor"/></svg>
            </div>
            <!-- Spider web decorations -->
            <div class="spiderweb spiderweb-tl">üï∏Ô∏è</div>
            <div class="spiderweb spiderweb-tr">üï∏Ô∏è</div>
            <div class="halloween-icon bat-1">ü¶á</div>
            <div class="halloween-icon bat-2">ü¶á</div>
            <div class="halloween-icon spider">üï∑Ô∏è</div>
          </div>
          <div class="videoWrap">
            <video id="video" playsinline></video>
            <canvas id="output"></canvas>
          </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
          <div class="status-header">
            <span class="pulse-icon">üíÄ</span>
            <h3>Vital Signs</h3>
          </div>
          <div class="status-grid">
            <div class="stat-item">
              <span class="stat-label">State</span>
              <span id="state" class="stat-value badge-idle">idle</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Target Face</span>
              <span id="targetFace" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">EAR Left</span>
              <span id="earL" class="stat-value mono">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">EAR Right</span>
              <span id="earR" class="stat-value mono">-</span>
            </div>
            <div class="stat-item full-width">
              <span class="stat-label">Mouth State</span>
              <span id="mouthPred" class="stat-value">-</span>
            </div>
            <div class="stat-item full-width">
              <span class="stat-label">Eyes Closed Duration</span>
              <span id="closedTime" class="stat-value danger">0.0s</span>
            </div>
            <div class="stat-item full-width">
              <span class="stat-label">Drowsy Count</span>
              <span id="drowsyCount" class="stat-value">0</span>
            </div>
          </div>
          <div id="msg" class="alert-message"></div>
          <div class="hints">
            <p class="hint">üí° Click face box or use ‚Üê/‚Üí to select target</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="cobweb cobweb-left">üï∏Ô∏è</div>
      <p>üîí Camera stays on-device ‚Ä¢ No data uploaded</p>
      <p class="tech-stack">Powered by MediaPipe Face Mesh √ó TensorFlow.js</p>
      <div class="cobweb cobweb-right">üï∏Ô∏è</div>
    </div>
  </footer>

  <!-- Mini-game overlay (Short Simon Sequence) -->
  <div id="miniGameOverlay" class="overlay" hidden>
    <div class="overlay-inner">
      <h2>Alertness Check: Simon Sequence</h2>
      <p class="hint">Watch the sequence, then repeat it by clicking the pads. Complete 2 sequences to continue
        <div>Round: <span id="mgRound">1</span>/2</div>
        <div>Timer: <span id="mgTimer">45</span>s</div>
        <div id="mgMsg"></div>
      </div>
      <div class="pads">
        <button class="pad pad-red"   data-pad="0" aria-label="Red"></button>
        <button class="pad pad-green" data-pad="1" aria-label="Green"></button>
        <button class="pad pad-blue"  data-pad="2" aria-label="Blue"></button>
        <button class="pad pad-yellow" data-pad="3" aria-label="Yellow"></button>
      </div>
      <div class="mg-actions">
        <button id="mgStartBtn">Start</button>
        <button id="mgExitBtn" class="secondary">Exit</button>
      </div>
    </div>
  </div>

  <!-- Park banner (speed gate) -->
  <div id="parkBanner" class="park-banner" hidden>
    <div class="park-banner-inner">
      <strong>Please park on the side and take the test.</strong>
      <div id="parkSub" class="park-sub">Waiting for the vehicle to stop‚Ä¶</div>
      <div class="park-actions">
        <button id="parkProceedBtn">I'm parked ‚Ä¢ Start test</button>
      </div>
    </div>
  </div>

  <!-- MediaPipe libs (no build needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <!-- TensorFlow.js for CNN eye/mouth classifiers (aligned with converter 4.22.0) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

  <script type="module" src="app.js?v=4"></script>
</body>
</html>
